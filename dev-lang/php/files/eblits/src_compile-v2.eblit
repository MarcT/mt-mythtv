# Copyright 1999-2010 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: $

eblit-php-src_compile() {
	
	SAPIS="${WORKDIR}/sapis"

	# set compile order
	local PHP_SAPIS="cli cgi embed apache2"
	
	local -A PHP_SAPI_TYPE=([cli]="static" [cgi]="static" [embed]="dynamic" [apache2]="dynamic")
	local PREV_SAPI=""

	for x in ${PHP_SAPIS}; do
		if use ${x} ; then

			# Possible problems with some SAPIs, which are linked as dynamic libraries. For example,
			# apache2 SAPI ignores-prefer-no-pic, and trying to use when linking PIC and non PIC
			# objects and build the wrong libphp5.so. So make full clean, for avoid that.
			if [[ ! -z "${PREV_SAPI}" ]] ; then
				if [[ "${PHP_SAPI_TYPE[${x}]}" != "${PHP_SAPI_TYPE[${PREV_SAPI}]}" ]] ;  then
					make clean
				else
					rm -f main/main.o main/main.lo main/php_ini.o \
						main/php_ini.lo 2>/dev/null
				fi
			fi

			case ${x} in
				cli)
					php_sapi_build ${x}
					cp sapi/cli/php "${SAPIS}/${x}/" \
						|| die "Unable to copy ${x} SAPI"
					;;
				cgi)
					php_sapi_build ${x}
					cp sapi/cgi/php-cgi "${SAPIS}/${x}/" \
						|| die "Unable to copy {$x} SAPI"
					;;
				embed)
					php_sapi_build ${x}
					cp libs/libphp${PHP_MV}.so "${SAPIS}/${x}/" \
						|| die "Unable to copy ${x} SAPI"
					;;
				apache2)
					php_sapi_build ${x}
					# apache2 is a special case; the necessary files (yes, multiple)
					# are copied by make install, not by the ebuild; that's the reason,
					# why apache2 has to be the last sapi
					;;
			esac

			PREV_SAPI="${x}"
		fi
	done
}

php_sapi_build() {
	local sapi="$1"
	php_set_ini_dir ${sapi}

	mkdir -p "${SAPIS}/${sapi}"

	sapi_conf="${my_conf} --with-config-file-path=${PHP_INI_DIR}
		--with-config-file-scan-dir=${PHP_EXT_INI_DIR_ACTIVE}"

	for available_sapi in cli cgi embed ; do
		if [[ $sapi == $available_sapi ]] ; then
			sapi_conf="${sapi_conf} --enable-${available_sapi}"
		else
			sapi_conf="${sapi_conf} --disable-${available_sapi}"
		fi
	done

	if [[ $sapi == "apache2" ]] ; then
		sapi_conf="${sapi_conf} --with-apxs2=/usr/sbin/apxs"
	else
		sapi_conf="${sapi_conf} --without-apxs2"
	fi

	econf ${sapi_conf}
	emake || die "emake failed"
}



